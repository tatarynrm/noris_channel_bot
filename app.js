require("dotenv").config();
const { Telegraf } = require("telegraf");
const { Pool } = require("pg");

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–æ—Ç–∞ —ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
const bot = new Telegraf(process.env.BOT_TOKEN);
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

// ID –∫–∞–Ω–∞–ª—É, –∫—É–¥–∏ –±—É–¥–µ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è
// const CHANNEL_ID = '@your_channel_name'; // –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ ID –≤–∞—à–æ–≥–æ –∫–∞–Ω–∞–ª—É
const CHANNEL_ID = "@official_noris"; // –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ ID –≤–∞—à–æ–≥–æ –∫–∞–Ω–∞–ª—É

// –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è
bot.action("vote", async (ctx) => {
  const userId = ctx.from.id;
  const username = ctx.from.username;

  try {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –≥–æ–ª–æ—Å—É–≤–∞–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–∞–Ω—ñ—à–µ
    const result = await pool.query("SELECT * FROM votes WHERE user_id = $1", [
      userId,
    ]);
    if (result.rows.length > 0) {
      // –Ø–∫—â–æ –∑–∞–ø–∏—Å —ñ—Å–Ω—É—î, –ø–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —â–æ –≤—ñ–Ω —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–≤
      await ctx.answerCbQuery("–í–∏ –≤–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–ª–∏!");

      // –ó–º—ñ–Ω–∞ —Ç–µ–∫—Å—Ç—É –∫–Ω–æ–ø–∫–∏ –Ω–∞ "–í–∏ –≤–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–ª–∏!" —ñ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≥–æ–ª–æ—Å—ñ–≤
      await ctx.editMessageReplyMarkup({
        inline_keyboard: [
          [{ text: "–ü—Ä–∏–π–Ω—è—Ç–∏ —É—á–∞—Å—Ç—åüòç", callback_data: "vote" }],
          [
            {
              text: "–î—ñ–∑–Ω–∞—Ç–∏—Å—å –∫-—Å—Ç—å —É—á–∞—Å–Ω–∏–∫—ñ–≤",
              callback_data: "vote_counter",
            },
          ],
        ],
      });
    } else {
      // –Ø–∫—â–æ –∑–∞–ø–∏—Å—É –Ω–µ–º–∞—î, –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –≥–æ–ª–æ—Å —É –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
      await pool.query(
        "INSERT INTO votes (user_id, username) VALUES ($1, $2)",
        [userId, username]
      );

      await ctx.answerCbQuery("–î—è–∫—É—î–º–æ –∑–∞ –≤–∞—à –≥–æ–ª–æ—Å!");

      // –ó–º—ñ–Ω–∞ —Ç–µ–∫—Å—Ç—É –∫–Ω–æ–ø–∫–∏ –Ω–∞ "–í–∏ –≤–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–ª–∏!" —ñ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≥–æ–ª–æ—Å—ñ–≤
      await ctx.editMessageReplyMarkup({
        inline_keyboard: [
            [{ text: "–ü—Ä–∏–π–Ω—è—Ç–∏ —É—á–∞—Å—Ç—åüòç", callback_data: "vote" }],
            [
              {
                text: "–î—ñ–∑–Ω–∞—Ç–∏—Å—å –∫-—Å—Ç—å —É—á–∞—Å–Ω–∏–∫—ñ–≤",
                callback_data: "vote_counter",
              },
            ],
          ],
      });
    }
  } catch (err) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å—ñ –≥–æ–ª–æ—Å—É:", err);
  }
});

// –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≥–æ–ª–æ—Å—ñ–≤
bot.action("vote_counter", async (ctx) => {
  try {
    // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≥–æ–ª–æ—Å—ñ–≤
    const result = await pool.query("SELECT COUNT(*) FROM votes");
    const count = result.rows[0].count;

    // –í—ñ–¥–ø–æ–≤—ñ–¥—å —ñ–∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –≥–æ–ª–æ—Å—ñ–≤
    await ctx.answerCbQuery(`–ó–∞—Ä–∞–∑ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–ª–æ ${count} —É—á–∞—Å–Ω–∏–∫—ñ–≤.`);
  } catch (err) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –≥–æ–ª–æ—Å—ñ–≤:", err);
    await ctx.answerCbQuery("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –≥–æ–ª–æ—Å—ñ–≤.");
  }
});
// –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –≤ –∫–∞–Ω–∞–ª
bot.command("send_vote", async (ctx) => {
  try {
    await bot.telegram.sendMessage(
      CHANNEL_ID,
      `üéâ **–†–æ–∑—ñ–≥—Ä–∞—à 200$ –¥–ª—è –Ω–æ–≤–∏—Ö –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤ TikTok!** üéâ
      
      üî• –•–æ—á–µ—à –≤–∏–≥—Ä–∞—Ç–∏ 200$? –£ –º–µ–Ω–µ —î —Å—É–ø–µ—Ä-–∞–∫—Ü—ñ—è –¥–ª—è —Ç–µ–±–µ! üî•
      
      –ü—Ä–æ—Å—Ç–æ –≤–∏–∫–æ–Ω—É–π –∫—ñ–ª—å–∫–∞ –ø—Ä–æ—Å—Ç–∏—Ö –∫—Ä–æ–∫—ñ–≤ —ñ –æ—Ç—Ä–∏–º—É–π —à–∞–Ω—Å –Ω–∞ –∫—Ä—É—Ç–∏–π –≤–∏–≥—Ä–∞—à! üí∏
      
      **–©–æ–± –≤–∑—è—Ç–∏ —É—á–∞—Å—Ç—å, –ø–æ—Ç—Ä—ñ–±–Ω–æ:**
      
      1Ô∏è‚É£ **–ü—ñ–¥–ø–∏—à–∏—Å—å –Ω–∞ –º—ñ–π TikTok** [@noris_real](https://www.tiktok.com/@noris_real)   
      2Ô∏è‚É£ **–ü—ñ–¥–ø–∏—à–∏—Å—å –Ω–∞ –º—ñ–π Telegram –∫–∞–Ω–∞–ª** [@official_noris](https://t.me/@official_noris) 
      3Ô∏è‚É£ **–ü—Ä–æ–≥–æ–ª–æ—Å—É–π —É —Ü—å–æ–º—É –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—ñ!** üìä  
      4Ô∏è‚É£ **–ü–æ–¥—ñ–ª–∏—Å—å —Ü–∏–º –ø–æ—Å—Ç–æ–º –∑ –¥—Ä—É–≥–æ–º** ü§ù  
      5Ô∏è‚É£ **–ü–æ—Å—Ç–∞–≤ –ª–∞–π–∫ –Ω–∞ –º–æ—ó –≤—ñ–¥–µ–æ –≤ –¢—ñ–∫–¢–æ–∫** ‚ù§Ô∏è 
      6Ô∏è‚É£**–ö–æ–º–µ–Ω—Ç—É–π –≤—ñ–¥–µ–æ —Ç–∞ –≤–∑–∞—î–º–æ–¥—ñ–π –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏ —ñ–Ω—à–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ –¥–ª—è –±—ñ–ª—å—à–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ** ‚ù§Ô∏è 
      
      ‚ú® **–£–º–æ–≤–∏ —Ä–æ–∑—ñ–≥—Ä–∞—à—É:**
      
      - üí∞ –ü—Ä–∏–∑: 200$ –¥–ª—è –æ–¥–Ω–æ–≥–æ —â–∞—Å–ª–∏–≤—á–∏–∫–∞!  
      - üóìÔ∏è –†–æ–∑—ñ–≥—Ä–∞—à –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è, –∫–æ–ª–∏ –Ω–∞ –º–æ—î–º—É –¢—ñ–∫–¢–æ–∫ –∞–∫–∫–∞—É–Ω—Ç—ñ –±—É–¥–µ 10,000 –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤.  
      - üìç –ü–µ—Ä–µ–º–æ–∂–µ—Ü—å –±—É–¥–µ –æ–±—Ä–∞–Ω–∏–π –≤–∏–ø–∞–¥–∫–æ–≤–∏–º —á–∏–Ω–æ–º —Å–µ—Ä–µ–¥ —Ç–∏—Ö, —Ö—Ç–æ –≤–∏–∫–æ–Ω–∞—î –≤—Å—ñ —É–º–æ–≤–∏!  
      - üíå –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ä–æ–∑—ñ–≥—Ä–∞—à—É –æ–≥–æ–ª–æ—à—É –Ω–∞ —Å–≤–æ—î–º—É TikTok —Ç–∞ –≤ Telegram!  
      
      üéØ **–í–∞–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ —É—Å—ñ —É–º–æ–≤–∏** üéØ
      
      –ù–µ –≥–∞–π—Ç–µ —á–∞—Å—É ‚Äî —É –≤–∞—Å —î –ª–∏—à–µ –æ–±–º–µ–∂–µ–Ω–∏–π —á–∞—Å, —â–æ–± –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Ä–æ–∑—ñ–≥—Ä–∞—à—É! ‚è≥
      
      üí• –£–¥–∞—á—ñ! üí•
      `,
      {
        parse_mode: "Markdown",
        reply_markup: {
            inline_keyboard: [
                [{ text: "–ü—Ä–∏–π–Ω—è—Ç–∏ —É—á–∞—Å—Ç—åüòç", callback_data: "vote" }],
                [
                  {
                    text: "–î—ñ–∑–Ω–∞—Ç–∏—Å—å –∫-—Å—Ç—å —É—á–∞—Å–Ω–∏–∫—ñ–≤",
                    callback_data: "vote_counter",
                  },
                ],
              ],
        },
        disable_web_page_preview: true,
      }
    );

    await ctx.reply("–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ –∫–∞–Ω–∞–ª.");
  } catch (err) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ –≤ –∫–∞–Ω–∞–ª:", err);
    await ctx.reply("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –≤ –∫–∞–Ω–∞–ª.");
  }
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch();
